#   (c) Copyright 2014 Hewlett-Packard Development Company, L.P.
#   All rights reserved. This program and the accompanying materials
#   are made available under the terms of the Apache License v2.0 which accompany this distribution.
#
#   The Apache License is available at
#   http://www.apache.org/licenses/LICENSE-2.0

namespace: docker.maintenance.flows

imports:
 docker_flows: docker.maintenance.flows
 email: email.ops

flow:
  name: report_mysql_status

  inputs:
    - dockerHost
    - dockerUsername
    - dockerPassword
    - containerID
    - mysqlUsername
    - mysqlPassword
    - emailHost
    - emailPort
    - emailSender
    - emailRecipient

  workflow:
    get_mysql_status:
          do:
            docker_flows.get_mysql_status:
                - dockerHost
                - dockerUsername
                - dockerPassword
                - containerID
                - mysqlUsername
                - mysqlPassword
          publish:
            - status
            - errorMessage

    send_status_mail:
          do:
            email.send_mail:
                - hostname: emailHost
                - port: emailPort
                - from: emailSender
                - to: emailRecipient
                - subject: "'MySQL Server Status on ' + dockerHost"
                - body: "'The MySQL server status on host ' + dockerHost + ' is detected as: ' + status"
          navigate:
            SUCCESS: SUCCESS
            FAILURE: FAILURE

    on_failure:
      send_error_mail:
        do:
          email.send_mail:
                - hostname: emailHost
                - port: emailPort
                - from: emailSender
                - to: emailRecipient
                - subject: "'MySQL Server Status on ' + dockerHost"
                - body: "'The MySQL server status checking on host ' + dockerHost + ' ended with the following error message: ' + errorMessage"
        navigate:
          SUCCESS: FAILURE
          FAILURE: FAILURE

